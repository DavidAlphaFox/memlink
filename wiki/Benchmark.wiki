#summary memlink性能测试、与redis，mysql的性能测试对比

= Introduction =

Memlink用于存储Key=>List数据，下面对比了不同数据存储引擎存储存储Key=>List数据的性能和内存开销。压力测试分为：客户端有长连接和短链接、N个并发数执行M个查询、在不同数据规模下等多种组合测试。


= Details =
硬件

OS：CentOS release 4.6 (Final) 
内核：2.6.9-67.0.22.ELsmp 32位<br/>
内存：4G <br/>
CPU：Intel(R) Xeon(R) CPU E5405  @ 2.00GHz （四核）<br/>
硬盘：250G SATA <br/> 


数据模型
{{{
CREATE TABLE `ThreadList` (
  `forumid` int(11) NOT NULL,
  `threadid` char(12) NOT NULL,
  `status` bit(1) DEFAULT 0,
  `reply_time` datetime NOT NULL,
  KEY `threadlist` (`forumid`,`reply_time`,`status`)
) ENGINE=Innodb DEFAULT CHARSET=utf8;
}}}

<font color="red"><b>memlink</b></font> <br/>
c:表示c客户端每秒操作成功条数，py:表示python客户端每秒操作成功条数，php:为php客户端每秒操作成功条数。mem:表示memlink server消耗内存。
insert为插入操作，range为获取列表某个范围的操作。插入的列表中的数据每条为12字节。

<font color="green"><b>redis</b></font><br/>
redis测试一样每条数据是12字节。redis只测试c客户端，使用hiredis。用LRANGE命令获取列表，用LPUSH向队列插入数据。redis是默认配置。

<font color="blue"><b>mysql</b></font><br/>
mysql使用上面的数据库表结构。插入语句为：insert into ThreadList values (1, 'xxxx', 0, now()) 查询列表的语句为：select threadid from  ThreadList where forumid=1 order by reply_time limit frompos,len

*1. 一个客户端，长连接*

memlink

|| *操作* || 1w || 10w || 100w || 1000w ||
|| insert<br/> mem:4764K || <font color="red">c:16296<br/> py:12558<br/> php:12153<br/> mem:5032K</font>|| <font color="red">c:14125<br/> py:12565<br/> php:12144<br/> mem:6628K </font>|| <font color="red">c:13868<br/> py: 13096<br/> php: 12521<br/> mem:18M </font>|| <font>c:13187<br/> py:12611<br/> php:12124<br/> mem:139M </font>||
|| range first100 || <font color="red">c:10874<br/> py:8275<br/> php:9185</font> || <font color="red">c:11429<br/> py:8273<br/> php:9171</font> || <font color="red">c:10994<br/> py:8068<br/> php:9136</font> || <font color="red">c:11663<br/> py:8256<br/> php:10071</font> ||
|| range first200 || <font color="red">c:8045<br/> py:6015<br/> php:6544</font> || <font color="red">c:8041<br/> py:6017<br/> php:6545</font> || <font color="red">c:7863<br/> py:5941<br/> php:6542</font> || <font color="red">c:7970<br/> py:6024<br/> php:7010</font> ||
|| range first1000 || <font color="red">c:1362<br/> py:1446<br/> php:1466</font> || <font color="red">c:1362<br/> py:1448<br/> php:1468</font> || <font color="red">c:1354<br/> py:1440<br/> php:1462</font> || <font color="red">c:1362<br/> py:1444<br/> php:1492</font> ||
|| range last100 || <font color="red">c:11153<br/> py:8137<br/> php:8996</font> || <font color="red">c:10318<br/> py:7526<br/> php:8263</font> || <font color="red">c:5519<br/> py:4410<br/> php:4691</font> || <font color="red">c:112<br/> py:97<br/> php:97</font> ||
|| range last200 || <font color="red">c:7938<br/> py:5956<br/> php:6461</font> || <font color="red">c:7515<br/> py:5629<br/> php:6078</font> || <font color="red">c:4615<br/> py:3688<br/> php:3899</font> || <font color="red">c:111<br/> py:96<br/> php:97</font> ||
|| range last1000 || <font color="red">c:1358<br/> py:1442<br/> php:1458</font> || <font color="red">c:1345<br/> py:1421<br/> php:1440</font> || <font color="red">c:1209<br/> py:1251<br/> php:1272</font> || <font color="red">c:103<br/> py:91<br/> php:91</font> ||

redis
|| *操作* || 1w || 10w || 100w || 1000w ||
|| insert<br/> mem:1060K || 15183<br/> mem:1920K || 14997<br/> mem:9044 || 14828<br/> mem:78M || 14788<br/> mem:771M ||
|| range first100 || 1328 || 1329 || 1324 || 1332 || 
|| range first200 || 708 || 709 || 705 || 709 ||
|| range first1000 || 147 || 148 || 148  || 147 ||
|| range last100 || 1221 || 212  || 19  || 2 ||
|| range last200 || 675 || 184 || 19 || 2 ||
|| range last1000 || 147 || 92 || 17 || 2 ||

mysql
|| *操作* || 1w || 10w || 100w || 1000w ||
|| insert || 10891 || 10297 || 10022 || 9718 ||
|| range first100 || 1550 || 1563 || 1559 || 1307 || 
|| range first200 || 956 || 954 || 956 || 941 ||
|| range first1000 || 230 || 230 || 230  || 235 ||
|| range last100 || 31 || 3  || 0.3  || 0.04 ||
|| range last200 || 31 || 3 || 0.3 || 0.04 ||
|| range last1000 || 30 || 3 || 0.3 || 0.03 ||

*2. 一个客户端， 全部是短连接。一次请求一个连接。*

memlink
|| *操作* || 1w || 10w || 100w || 1000w ||
|| insert<br/> mem:4760K || c:6560<br/> py:6138<br/> php:6064<br/> mem:5108K || c:6466<br/> py:5990<br/> php:5986<br/> mem:6704K || c:6675<br/> py:6092<br/> php:6010<br/> mem:18M || c:6719<br/> py:6012<br/> php:6003<br/> mem:139M ||
|| range first100 || c:5467<br/> py:4535<br/> php:5064 || c:5472<br/> py:4450<br/> php:4944 || c:5662<br/> py:4495<br/> php:4712 || c:5484<br/> py:4475<br/> php:4779 ||
|| range first200 || c:4533<br/> py:3746<br/> php:4124 || c:4563<br/> py:3693<br/> php:4049 || c:4709<br/> py:3724<br/> php:3893 || c:4567<br/> py:3708<br/> php:3931 ||
|| range first1000 || c:1206<br/> py:1254<br/> php:1291 || c:1200<br/> py:1249<br/> php:1285 || c:1215<br/> py:1253<br/> php:1263 || c:1202<br/> py:1250<br/> php:1266 ||
|| range last100 || c:5468<br/> py:4451<br/> php:4970 || c:5229<br/> py:4233<br/> php:4692 || c:3763<br/> py:3055<br/> php:3155 || c:110<br/> py:96<br/> php:96 ||
|| range last200 || c:4558<br/> py:3692<br/> php:4053 || c:4355<br/> py:3545<br/> php:3886 || c:3323<br/> py:2680<br/> php:2790 || c:110<br/> py:95<br/> php:96 ||
|| range last1000 || c:1198<br/> py:1247<br/> php:1284 || c:1191<br/> py:1226<br/> php:1267 || c:1096<br/> py:1093<br/> php:1125 || c:102<br/> py:91<br/> php:91 ||


redis
|| *操作* || 1w || 10w || 100w || 1000w ||
|| insert || 10891 || 10297 || 10233 || 10135 ||
|| range first100 || 1058 || 1172 || 1166 || 1163 || 
|| range first200 || 654 || 651 || 669 || 667 ||
|| range first1000 || 146 || 145 || 145  || 144 ||
|| range last100 || 994 || 271  || 32  || 3 ||
|| range last200 || 630 || 233 || 32 || 3 ||
|| range last1000 || 144 || 104 || 27 || 3 ||

mysql
|| *操作* || 1w || 10w || 100w || 1000w ||
|| insert || 3313 || 3251 || 3108 || 3001 ||
|| range first100 || 923 || 1158 || 1031 || 885 || 
|| range first200 || 815 || 823 || 783 || 743 ||
|| range first1000 || 227 || 230 || 226  || 212 ||
|| range last100 || 20 || 3 || 0.21  || 0.02 ||
|| range last200 || 30 || 3 || 0.3 || 0.04 ||
|| range last1000 || 30 || 3 || 0.3 || 0.03 ||

*3. 10个客户端，并发长连接。

memlink内部开启4个处理线程。仅c客户端测试。
|| *操作* || 1w || 10w || 100w || 1000w ||
|| insert || 23021 || 22210 || 22200 || 22242 ||
|| range first100 || 45451 || 53463 || 55645 || 48283 ||
|| range first200 || 23768 || 33966 || 35045 || 35417 ||
|| range first1000 || 4269 || 4305 || 4281 || 4271 ||
|| range last100 || 53719 || 48948 || 24086 || 295 ||
|| range last200 || 35593 || 34264 || 21830 || 292 ||
|| range last1000 || 4285 || 4270 || 4336 || 277 ||


redis
|| *操作* || 1w || 10w || 100w || 1000w ||
|| insert || 29401 || 30929 || 29109 || 30278 ||
|| range first100 || 1443 || 1384 || 1396 || 1339 || 
|| range first200 || 667 || 641 || 636 || 655 ||
|| range first1000 || 114 || 115 || 114 || 115 ||
|| range last100 || 1584 || 229  || 19  || 2 ||
|| range last200 || 696 || 220 || 19 || 2 ||
|| range last1000 || 114 || 142 || 19 || 2 ||


mysql
|| *操作* || 1w || 10w || 100w || 1000w ||
|| insert || 13704 || 12786 || 12087 || 11023 ||
|| range first100 || 2011 || 2059 || 2015 || 2387 || 
|| range first200 || 1637 || 1768 || 1854 || 1614 ||
|| range first1000 || 654 || 641 || 648 || 631 ||
|| range last100 || 91 || 8 || 1 || - ||
|| range last200 || 96 || 9 || 1 || - ||
|| range last1000 || 91 || 8 || 1 || - ||

上面的 - 表示时间太长，数百秒也没有结果。

*4. 10个客户端，并发短连接*

Memlink内部开启4个处理线程。仅c客户端测试。
|| *操作* || 1w || 10w || 100w || 1000w ||
|| insert || 9665 || 9650 || 10078 || 10183 ||
|| range first100 || 17400 || 17504 || 16614 || 17292 ||
|| range first200 || 15786 || 15772 || 15964 || 16180 ||
|| range first1000 || 3795 || 3918 || 3703 || 3250 ||
|| range last100 || 16989 || 16502 || 13118 || 319 ||
|| range last200 || 15915 || 15596 || 12203 || 316 ||
|| range last1000 || 3893 || 3641 || 3332 || 299 ||

redis
|| *操作* || 1w || 10w || 100w || 1000w ||
|| insert || 9381 || 9489 || 8993 || 8976 ||
|| range first100 || 1695 || 1637 || 1696 || 1586 || 
|| range first200 || 711 || 711 || 719 || 692 ||
|| range first1000 || 118 || 115 || 116  || 114 ||
|| range last100 || 2132 || 240  || 20  || 2 ||
|| range last200 || 743 || 229 || 20 || 2 ||
|| range last1000 || 120 || 174 || 19 || 2 ||

mysql
|| *操作* || 1w || 10w || 100w || 1000w ||
|| insert || 5623 || 5621 || 5468 || 5306 ||
|| range first100 || 2210 || 2286 || 1955 || 1611 || 
|| range first200 || 1444 || 1791 || 1870 || 1402 ||
|| range first1000 || 550 || 692 || 620 || 686 ||
|| range last100 || 80 || 8 || 1 || - ||
|| range last200 || 94 || 9 || 1 || - ||
|| range last1000 || 94 || 9 || 1 || - ||

= FAQ =

 # *为什么memlink的读速度会比redis快？*
  这个是内部存储数据结构决定的。redis内部是一个链表。memlink内部同样是链表，不同的是memlink把100个value组织到了一个链表数据块内，这样循环查找位置的时候，memlink理论上最好情况，循环次数比redis少100倍。
 # *为什么在多线程并发的情况下memlink比redis读速度快很多？*
  因为memlink读数据是完全多线程的，并且没有同步锁，可以利用到多核。而redis在读取数据上是单线程的。